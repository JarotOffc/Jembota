<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oscar Store - Topup QRIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <style>
    /* Animasi pulse */
    @keyframes pulse {0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34,197,94,0.7); }70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(34,197,94,0); }100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34,197,94,0); }}
    .pulse { animation: pulse 2s infinite; }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans flex">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="w-64 bg-gray-800 min-h-screen p-6 hidden md:block">
    <h1 class="text-xl font-bold mb-6">Oscar Store</h1>
    <nav class="space-y-3">
      <button onclick="showSection('login')" class="w-full text-left px-3 py-2 bg-gray-700 rounded hover:bg-gray-600">Login</button>
      <button onclick="showSection('register')" class="w-full text-left px-3 py-2 bg-gray-700 rounded hover:bg-gray-600">Register</button>
      <button onclick="showSection('topup')" class="w-full text-left px-3 py-2 bg-gray-700 rounded hover:bg-gray-600">Topup</button>
      <button onclick="logout()" class="w-full text-left px-3 py-2 bg-red-600 rounded hover:bg-red-500" id="logoutBtn" style="display:none">Logout</button>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-6">
    <!-- LOGIN -->
    <section id="login" class="max-w-md mx-auto">
      <h2 class="text-2xl font-bold mb-4">Login</h2>
      <form onsubmit="login(event)" class="bg-gray-800 p-4 rounded space-y-3">
        <input type="email" id="loginEmail" placeholder="Email" class="p-2 rounded text-black w-full" required>
        <input type="password" id="loginPassword" placeholder="Password" class="p-2 rounded text-black w-full" required>
        <button type="submit" class="bg-green-600 px-4 py-2 rounded w-full">Login</button>
      </form>
    </section>

    <!-- REGISTER -->
    <section id="register" class="max-w-md mx-auto hidden">
      <h2 class="text-2xl font-bold mb-4">Register</h2>
      <form onsubmit="register(event)" class="bg-gray-800 p-4 rounded space-y-3">
        <input type="email" id="regEmail" placeholder="Email" class="p-2 rounded text-black w-full" required>
        <input type="password" id="regPassword" placeholder="Password" class="p-2 rounded text-black w-full" required>
        <button type="submit" class="bg-blue-600 px-4 py-2 rounded w-full">Register</button>
      </form>
    </section>

    <!-- TOPUP -->
    <section id="topup" class="max-w-md mx-auto hidden">
      <h2 class="text-2xl font-bold mb-4">Topup Saldo</h2>
      <form onsubmit="handleTopup(event)" class="bg-gray-800 p-4 rounded space-y-3">
        <input id="topupAmount" type="number" placeholder="Masukkan jumlah topup" class="p-2 rounded text-black w-full" required>
        <button type="submit" class="bg-green-600 px-4 py-2 rounded w-full">Topup</button>
      </form>

      <section id="riwayat" class="mt-8 hidden">
        <h3 class="text-xl font-semibold mb-3">Riwayat Transaksi</h3>
        <ul id="riwayatList" class="space-y-2"></ul>
      </section>

      <!-- QRIS MODAL -->
      <div id="qrisModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center">
        <div class="bg-gray-800 p-6 rounded w-96 text-center">
          <div class="bg-red-600 text-white p-2 rounded mb-4 text-sm font-semibold flex items-center justify-center">
            ❗ Wajib upload bukti transaksi agar valid
          </div>
          <h3 class="text-lg font-bold mb-4">Silakan Scan QRIS untuk Membayar</h3>
          <img src="https://qu.ax/rxZsZ.jpg" alt="QRIS Code" class="mx-auto mb-4 border-4 border-white rounded">
          <button onclick="confirmPayment()" class="bg-blue-600 px-4 py-2 rounded w-full">Konfirmasi Pembayaran</button>
          <button onclick="closeQris()" class="mt-3 text-sm text-gray-400">Tutup</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-center p-6 mt-10 w-full">
    <p class="text-gray-400 text-sm">© 2025 Oscar Store.</p>
  </footer>

  <script>
    // ----- Supabase Setup -----
    const SUPABASE_URL = "https://YOUR_SUPABASE_URL.supabase.co";
    const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ----- Sidebar Navigation -----
    function showSection(id) {
      document.querySelectorAll("main > section").forEach(sec => sec.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    // ----- AUTH -----
    async function register(e) {
      e.preventDefault();
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert("Berhasil daftar! Silahkan cek email untuk konfirmasi.");
      showSection("login");
    }

    async function login(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      alert("Login berhasil!");
      showSection("topup");
      document.getElementById("logoutBtn").style.display = "block";
      loadRiwayat(); // load riwayat jika ada
    }

    async function logout() {
      await supabase.auth.signOut();
      alert("Logout berhasil!");
      showSection("login");
      document.getElementById("logoutBtn").style.display = "none";
    }

    // ----- TOPUP -----
    let topupAmount = 0;

    function handleTopup(e) {
      e.preventDefault();
      topupAmount = document.getElementById("topupAmount").value;
      if (!topupAmount || topupAmount <= 0) return alert("Jumlah tidak valid!");
      document.getElementById("qrisModal").classList.remove("hidden");
    }

    function closeQris() { document.getElementById("qrisModal").classList.add("hidden"); }

    async function confirmPayment() {
      const user = supabase.auth.getUser();
      const adminNumber = "6285850539404";
      const message = `Halo Admin, saya baru saja melakukan pembayaran topup sebesar Rp${topupAmount}.`;
      const waUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;

      // Simpan transaksi di localStorage (atau bisa di Supabase table nanti)
      saveRiwayat(topupAmount, "Pending");

      window.open(waUrl, "_blank"); 
      closeQris();
      setTimeout(() => location.reload(), 2000);
    }

    function saveRiwayat(amount, status) {
      let riwayat = JSON.parse(localStorage.getItem("riwayatTopup")) || [];
      const tanggal = new Date().toLocaleString();
      riwayat.push({ id: Date.now(), jumlah: amount, waktu: tanggal, status: status });
      localStorage.setItem("riwayatTopup", JSON.stringify(riwayat));
      loadRiwayat();
    }

    function loadRiwayat() {
      let riwayat = JSON.parse(localStorage.getItem("riwayatTopup")) || [];
      const list = document.getElementById("riwayatList");
      list.innerHTML = "";
      if (riwayat.length > 0) {
        document.getElementById("riwayat").classList.remove("hidden");
        riwayat.forEach(r => {
          const li = document.createElement("li");
          li.className = "bg-gray-800 p-3 rounded";
          let statusColor = r.status === "Berhasil" ? "text-green-400" : "text-yellow-400";
          li.innerHTML = `
            <p>Topup Rp${r.jumlah}</p>
            <p class="text-sm text-gray-400">${r.waktu}</p>
            <p class="text-sm ${statusColor} font-semibold">Status: ${r.status}</p>
          `;
          list.appendChild(li);
        });
      }
    }

    // Auto set pending -> berhasil saat reload
    window.onload = function() { loadRiwayat(); }
  </script>
</body>
</html>
